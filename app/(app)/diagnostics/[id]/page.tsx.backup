"use client";
import { useState, useEffect } from "react";
import { useParams, notFound } from "next/navigation";
import { createClient } from "@supabase/supabase-js";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import FormError from "@/components/forms/FormError";
import { DiabetesFormSchema, CvdFormSchema, parseNumber } from "@/lib/validation/testSchemas";
import type { DiabetesForm, CvdForm } from "@/lib/validation/testSchemas";
import { useFormErrors } from "@/hooks/useFormErrors";
import PageContainer from "@/components/app/PageContainer";
import RiskPanel from "@/components/results/RiskPanel";
import { motion } from "framer-motion";
import { Check } from "lucide-react";

interface DiagnosticRecord {
  id: string;
  user_id: string;
  symptom: string;
  ai_summary: string;
  hospital: string;
  scheduled_date: string;
  test_name?: string;
  status: string;
  created_at: string;
  updated_at: string;
}

interface TestRecord {
  id: string;
  diagnostic_id: string;
  test_name: string;
  status: string;
  result_file: string;
  test_id: string;
}

interface Appointment {
  id: string;
  user_id: string;
  diagnostic_id: string;
  appointment_date: string;
  appointment_time: string;
  status: string;
  created_at: string;
}

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
);

interface DiabetesFormData {
  age: number;
  sex: string;
  bmi: number;
  sbp: number; // systolic blood pressure
  onBpTherapy: boolean;
  hdl: number; // HDL cholesterol (mg/dL)
  tg: number; // Triglycerides (mg/dL)
  fastingGlucose: number; // Fasting glucose (mg/dL)
  parentalHistory: boolean;
}

interface MLResponse {
  prediction: number;
  probability: number;
  message?: string;
}

interface CardiovascularFormData {
  age: number;
  sex: string;
  is_smoking: string;
  cigsPerDay: number;
  BPMeds: number;
  prevalentStroke: number;
  prevalentHyp: number;
  diabetes: number;
  totChol: number;
  hdl: number;
  sysBP: number;
  diaBP: number;
  BMI: number;
  heartRate: number;
}

function DiabetesTestModal({
  test,
  diagnostic,
  onClose,
  onAppointmentBooked,
}: {
  test: TestRecord;
  diagnostic: DiagnosticRecord;
  onClose: () => void;
  onAppointmentBooked?: () => void;
}) {
  const [formData, setFormData] = useState<DiabetesFormData>({
    age: 0,
    sex: "",
    bmi: 0,
    sbp: 0,
    onBpTherapy: false,
    hdl: 0,
    tg: 0,
    fastingGlucose: 0,
    parentalHistory: false,
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);
  const [result, setResult] = useState<MLResponse | null>(null);
  const { errors, setErrors, fromZod, focusFirstInvalid, clearError, clearAll } = useFormErrors();

  const handleInputChange = (field: keyof DiabetesFormData, value: string | boolean) => {
    setFormData((prev) => ({
      ...prev,
      [field]: typeof value === "boolean" 
        ? value 
        : field === "sex" 
          ? value 
          : (parseFloat(value as string) || 0),
    }));
    // Clear error for this field when user starts typing
    clearError(field);
  };

  const handleSubmit = async () => {
    // Build form object with proper types
    const formToValidate: DiabetesForm = {
      age: parseNumber(formData.age) ?? 0,
      sex: formData.sex as "male" | "female",
      bmi: parseNumber(formData.bmi) ?? 0,
      sbp: parseNumber(formData.sbp) ?? 0,
      onBpTherapy: formData.onBpTherapy,
      hdl: parseNumber(formData.hdl) ?? 0,
      tg: parseNumber(formData.tg) ?? 0,
      fastingGlucose: parseNumber(formData.fastingGlucose) ?? 0,
      parentalHistory: formData.parentalHistory,
    };

    // Validate with Zod
    const validationResult = DiabetesFormSchema.safeParse(formToValidate);

    if (!validationResult.success) {
      // Extract errors using hook
      const newErrors = fromZod(validationResult);
      setErrors(newErrors);
      // Focus first invalid field
      focusFirstInvalid();
      return;
    }

    // Clear errors and proceed with API call
    clearAll();
    setIsSubmitting(true);
    try {
      const response = await fetch("/api/predict-diabetes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          testId: test.id,
          ...formData,
        }),
      });

      const data = await response.json();

      setResult(data);
      setShowSuccess(true);
      setTimeout(() => setShowSuccess(false), 2000);
    } catch (error) {
      console.error("Error submitting diabetes test:", error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Keyboard shortcut handler
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        handleSubmit();
      }
    };
    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData]);

  return (
    <DialogContent className="max-w-3xl max-h-[85vh] overflow-y-auto">
      <DialogHeader>
        <DialogTitle className="text-2xl font-semibold text-gradient">
          Diabetes Risk Assessment
        </DialogTitle>
        <p className="text-sm text-muted-foreground mt-2">
          Complete the form below to calculate your diabetes risk using the Framingham Offspring Study model
        </p>
      </DialogHeader>

      <div className="space-y-8">
        {/* Demographics Section */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-brand-500 to-brand-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Demographics
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="age" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Age
                </Label>
                <div className="flex-1 relative">
                  <Input
                    id="age"
                    type="number"
                    min="0"
                    placeholder="Years"
                    value={formData.age || ""}
                    onChange={(e) => handleInputChange("age", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.age}
                    aria-describedby={errors.age ? "age-error" : "age-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.age ? (
                  <FormError id="age-error" message={errors.age} />
                ) : (
                  <p id="age-help" className="text-xs text-muted-foreground">
                    Must be 20-74 years old
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="sex" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Sex
                </Label>
                <div className="flex-1">
                  <select
                    id="sex"
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    value={formData.sex}
                    onChange={(e) => handleInputChange("sex", e.target.value)}
                    aria-invalid={!!errors.sex}
                    aria-describedby={errors.sex ? "sex-error" : "sex-help"}
                  >
                    <option value="">Select...</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.sex ? (
                  <FormError id="sex-error" message={errors.sex} />
                ) : (
                  <p id="sex-help" className="text-xs text-muted-foreground">
                    Biological sex at birth
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Physical Measurements */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-cyan-500 to-cyan-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Physical Measurements
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="bmi" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  BMI
                </Label>
                <div className="flex-1">
                  <Input
                    id="bmi"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="kg/m²"
                    value={formData.bmi || ""}
                    onChange={(e) => handleInputChange("bmi", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.bmi}
                    aria-describedby={errors.bmi ? "bmi-error" : "bmi-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.bmi ? (
                  <FormError id="bmi-error" message={errors.bmi} />
                ) : (
                  <p id="bmi-help" className="text-xs text-muted-foreground">
                    Body Mass Index (18-60 typical range)
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="sbp" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Systolic BP
                </Label>
                <div className="flex-1">
                  <Input
                    id="sbp"
                    type="number"
                    min="0"
                    placeholder="mmHg"
                    value={formData.sbp || ""}
                    onChange={(e) => handleInputChange("sbp", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.sbp}
                    aria-describedby={errors.sbp ? "sbp-error" : "sbp-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.sbp ? (
                  <FormError id="sbp-error" message={errors.sbp} />
                ) : (
                  <p id="sbp-help" className="text-xs text-muted-foreground">
                    Top number (90-200 mmHg typical)
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Lab Values */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-purple-500 to-purple-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Lab Values
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="hdl" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  HDL Cholesterol
                </Label>
                <div className="flex-1">
                  <Input
                    id="hdl"
                    type="number"
                    min="0"
                    placeholder="mg/dL"
                    value={formData.hdl || ""}
                    onChange={(e) => handleInputChange("hdl", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.hdl}
                    aria-describedby={errors.hdl ? "hdl-error" : "hdl-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.hdl ? (
                  <FormError id="hdl-error" message={errors.hdl} />
                ) : (
                  <p id="hdl-help" className="text-xs text-muted-foreground">
                    Good cholesterol (20-100 mg/dL)
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="tg" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Triglycerides
                </Label>
                <div className="flex-1">
                  <Input
                    id="tg"
                    type="number"
                    min="0"
                    placeholder="mg/dL"
                    value={formData.tg || ""}
                    onChange={(e) => handleInputChange("tg", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.tg}
                    aria-describedby={errors.tg ? "tg-error" : "tg-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.tg ? (
                  <FormError id="tg-error" message={errors.tg} />
                ) : (
                  <p id="tg-help" className="text-xs text-muted-foreground">
                    Blood fats (30-500 mg/dL typical)
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="fastingGlucose" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Fasting Glucose
                </Label>
                <div className="flex-1">
                  <Input
                    id="fastingGlucose"
                    type="number"
                    min="0"
                    placeholder="mg/dL"
                    value={formData.fastingGlucose || ""}
                    onChange={(e) => handleInputChange("fastingGlucose", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.fastingGlucose}
                    aria-describedby={errors.fastingGlucose ? "fastingGlucose-error" : "fastingGlucose-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.fastingGlucose ? (
                  <FormError id="fastingGlucose-error" message={errors.fastingGlucose} />
                ) : (
                  <p id="fastingGlucose-help" className="text-xs text-muted-foreground">
                    After 8hr fast (70-125 mg/dL normal)
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Medical History */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-pink-500 to-pink-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Medical History
            </h3>
          </div>
          
          <div className="space-y-4">
            <div className="flex items-start gap-3 p-3 rounded-lg hover:bg-muted/50 transition-colors">
              <input
                id="onBpTherapy"
                type="checkbox"
                className="mt-0.5 h-4 w-4 rounded border-gray-300 text-brand-600 focus:ring-brand-500"
                checked={formData.onBpTherapy}
                onChange={(e) => handleInputChange("onBpTherapy", e.target.checked)}
              />
              <div className="flex-1">
                <Label htmlFor="onBpTherapy" className="cursor-pointer font-medium">
                  Currently on blood pressure medication
                </Label>
                <p className="text-xs text-muted-foreground mt-1">
                  Check if taking antihypertensive drugs
                </p>
              </div>
            </div>

            <div className="flex items-start gap-3 p-3 rounded-lg hover:bg-muted/50 transition-colors">
              <input
                id="parentalHistory"
                type="checkbox"
                className="mt-0.5 h-4 w-4 rounded border-gray-300 text-brand-600 focus:ring-brand-500"
                checked={formData.parentalHistory}
                onChange={(e) => handleInputChange("parentalHistory", e.target.checked)}
              />
              <div className="flex-1">
                <Label htmlFor="parentalHistory" className="cursor-pointer font-medium">
                  Parental history of diabetes
                </Label>
                <p className="text-xs text-muted-foreground mt-1">
                  Either parent diagnosed with diabetes
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="pt-2 pb-1 border-t">
          <p className="text-xs text-muted-foreground text-center">
            This is an educational risk assessment based on the Framingham Offspring Diabetes Study model. Not a medical diagnosis.
          </p>
        </div>

        {result && (
          <RiskPanel
            label="Diabetes Risk Assessment"
            probability={result.probability}
            drivers={[
              "Blood glucose levels above normal range",
              "BMI indicates overweight/obesity category",
              "Systolic blood pressure elevated",
            ]}
            onBookAppointment={async () => {
              try {
                const response = await fetch("/api/appointments", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId: diagnostic?.user_id,
                    diagnosticId: test.diagnostic_id,
                  }),
                });

                if (response.ok) {
                  alert(
                    "✅ Appointment scheduled successfully! Check the appointments section below or visit /appointments to manage it."
                  );
                  onAppointmentBooked?.();
                } else {
                  alert(
                    "❌ Failed to submit appointment request. Please try again."
                  );
                }
              } catch (error) {
                console.error("Error booking appointment:", error);
                alert(
                  "❌ Error submitting appointment request. Please try again."
                );
              }
            }}
            onDownloadFHIR={() => {
              // TODO: Implement FHIR export
              alert("FHIR export coming soon!");
            }}
            className="mt-6"
          />
        )}

        <div className="flex gap-3 pt-4">
          <Button variant="outline" onClick={onClose} className="flex-1">
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="flex-1 bg-gradient-to-r from-brand-500 to-cyan-500 hover:from-brand-600 hover:to-cyan-600 text-white shadow-lg hover:shadow-xl transition-all relative group"
          >
            {showSuccess ? (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                className="flex items-center gap-2"
              >
                <Check className="w-4 h-4" />
                Saved
              </motion.div>
            ) : isSubmitting ? (
              "Processing..."
            ) : (
              <>
                Run ML Prediction
                <kbd className="ml-2 hidden sm:inline-flex h-5 px-1.5 items-center gap-1 rounded border bg-white/20 text-[10px] font-medium text-white">
                  {typeof navigator !== "undefined" && navigator.platform.includes("Mac") ? "⌘" : "Ctrl"} Enter
                </kbd>
              </>
            )}
          </Button>
        </div>
      </div>
    </DialogContent>
  );
}

function CardiovascularTestModal({
  test,
  diagnostic,
  onClose,
  onAppointmentBooked,
}: {
  test: TestRecord;
  diagnostic: DiagnosticRecord;
  onClose: () => void;
  onAppointmentBooked?: () => void;
}) {
  const [formData, setFormData] = useState<CardiovascularFormData>({
    age: 0,
    sex: "M",
    is_smoking: "NO",
    cigsPerDay: 0,
    BPMeds: 0,
    prevalentStroke: 0,
    prevalentHyp: 0,
    diabetes: 0,
    totChol: 0,
    hdl: 0,
    sysBP: 0,
    diaBP: 0,
    BMI: 0,
    heartRate: 0,
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);
  const [result, setResult] = useState<MLResponse | null>(null);
  const { errors, setErrors, fromZod, focusFirstInvalid, clearError, clearAll } = useFormErrors();

  // Map form fields to validation schema fields
  const fieldNameMap: Record<string, string> = {
    is_smoking: "smoker",
    BPMeds: "treated",
    totChol: "totalChol",
    sysBP: "sbp",
  };

  // Reverse map for focusing (validation field -> form field ID)
  const validationToFormFieldMap: Record<string, string> = {
    smoker: "is_smoking",
    treated: "BPMeds",
    totalChol: "totChol",
    sbp: "sysBP",
  };

  const handleInputChange = (
    field: keyof CardiovascularFormData,
    value: string | number
  ) => {
    setFormData((prev) => ({
      ...prev,
      [field]:
        typeof value === "string" ? value : parseFloat(value.toString()) || 0,
    }));
    // Clear error for this field when user starts typing
    const errorKey = fieldNameMap[field] || field;
    clearError(errorKey);
  };

  const handleSubmit = async () => {
    // Build form object for validation (map to CvdFormSchema fields)
    const formToValidate: CvdForm = {
      sex: formData.sex === "M" ? "male" : "female",
      age: parseNumber(formData.age) ?? 0,
      totalChol: parseNumber(formData.totChol) ?? 0,
      hdl: parseNumber(formData.hdl) ?? 0,
      sbp: parseNumber(formData.sysBP) ?? 0,
      treated: formData.BPMeds === 1,
      smoker: formData.is_smoking === "YES",
      diabetes: formData.diabetes === 1,
    };

    // Validate with Zod
    const validationResult = CvdFormSchema.safeParse(formToValidate);

    if (!validationResult.success) {
      // Extract errors using hook
      const newErrors = fromZod(validationResult);
      setErrors(newErrors);
      // Focus first invalid field with field name mapping
      focusFirstInvalid(validationToFormFieldMap);
      return;
    }

    // Clear errors and proceed with API call
    clearAll();
    setIsSubmitting(true);
    try {
      // Encode Yes/No and M/F values properly
      const encodedData = {
        ...formData,
        sex: formData.sex === "M" ? "M" : "F",
        is_smoking: formData.is_smoking === "YES" ? "YES" : "NO",
        BPMeds: Number(formData.BPMeds) === 1 ? 1 : 0,
        prevalentStroke: Number(formData.prevalentStroke) === 1 ? 1 : 0,
        prevalentHyp: Number(formData.prevalentHyp) === 1 ? 1 : 0,
        diabetes: Number(formData.diabetes) === 1 ? 1 : 0,
      };

      const response = await fetch("/api/predict-heart", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          testId: test.id,
          ...encodedData,
        }),
      });

      const data = await response.json();
      setResult(data);
      setShowSuccess(true);
      setTimeout(() => setShowSuccess(false), 2000);
    } catch (error) {
      console.error("Error submitting cardiovascular test:", error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Keyboard shortcut handler
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        handleSubmit();
      }
    };
    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData]);

  return (
    <DialogContent className="max-w-3xl max-h-[85vh] overflow-y-auto">
      <DialogHeader>
        <DialogTitle className="text-2xl font-semibold text-gradient">
          Cardiovascular Risk Assessment
        </DialogTitle>
        <p className="text-sm text-muted-foreground mt-2">
          Complete the form below to calculate your 10-year CVD risk using the Framingham Heart Study model
        </p>
      </DialogHeader>

      <div className="space-y-8">
        {/* Demographics Section */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-brand-500 to-brand-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Demographics
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="age" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Age
                </Label>
                <div className="flex-1">
                  <Input
                    id="age"
                    type="number"
                    min="0"
                    max="120"
                    placeholder="Years"
                    value={formData.age || ""}
                    onChange={(e) => handleInputChange("age", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.age}
                    aria-describedby={errors.age ? "age-error" : "age-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.age ? (
                  <FormError id="age-error" message={errors.age} />
                ) : (
                  <p id="age-help" className="text-xs text-muted-foreground">
                    Must be 30-74 years old
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="sex" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Sex
                </Label>
                <div className="flex-1">
                  <select
                    id="sex"
                    value={formData.sex}
                    onChange={(e) => handleInputChange("sex", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    aria-invalid={!!errors.sex}
                    aria-describedby={errors.sex ? "sex-error" : "sex-help"}
                  >
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.sex ? (
                  <FormError id="sex-error" message={errors.sex} />
                ) : (
                  <p id="sex-help" className="text-xs text-muted-foreground">
                    Biological sex at birth
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Lifestyle Factors */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-orange-500 to-orange-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Lifestyle Factors
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="is_smoking" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Smoking Status
                </Label>
                <div className="flex-1">
                  <select
                    id="is_smoking"
                    value={formData.is_smoking}
                    onChange={(e) => handleInputChange("is_smoking", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    aria-invalid={!!errors.smoker}
                    aria-describedby={errors.smoker ? "smoker-error" : "smoker-help"}
                  >
                    <option value="NO">Non-smoker</option>
                    <option value="YES">Current smoker</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.smoker ? (
                  <FormError id="smoker-error" message={errors.smoker} />
                ) : (
                  <p id="smoker-help" className="text-xs text-muted-foreground">
                    Current smoking habits
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="cigsPerDay" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Cigarettes/Day
                </Label>
                <div className="flex-1">
                  <Input
                    id="cigsPerDay"
                    type="number"
                    min="0"
                    placeholder="Number"
                    value={formData.cigsPerDay || ""}
                    onChange={(e) => handleInputChange("cigsPerDay", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  If applicable (0-60 typical)
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Lab Values */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-purple-500 to-purple-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Lab Values
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="totChol" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Total Cholesterol
                </Label>
                <div className="flex-1">
                  <Input
                    id="totChol"
                    type="number"
                    min="0"
                    placeholder="mg/dL"
                    value={formData.totChol || ""}
                    onChange={(e) => handleInputChange("totChol", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.totalChol}
                    aria-describedby={errors.totalChol ? "totalChol-error" : "totalChol-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.totalChol ? (
                  <FormError id="totalChol-error" message={errors.totalChol} />
                ) : (
                  <p id="totalChol-help" className="text-xs text-muted-foreground">
                    Total serum cholesterol (100-400 mg/dL)
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="hdl" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  HDL Cholesterol
                </Label>
                <div className="flex-1">
                  <Input
                    id="hdl"
                    type="number"
                    min="0"
                    placeholder="mg/dL"
                    value={formData.hdl || ""}
                    onChange={(e) => handleInputChange("hdl", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.hdl}
                    aria-describedby={errors.hdl ? "hdl-error" : "hdl-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.hdl ? (
                  <FormError id="hdl-error" message={errors.hdl} />
                ) : (
                  <p id="hdl-help" className="text-xs text-muted-foreground">
                    Good cholesterol (20-100 mg/dL)
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Blood Pressure & Vitals */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-cyan-500 to-cyan-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Blood Pressure & Vitals
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="sysBP" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Systolic BP
                </Label>
                <div className="flex-1">
                  <Input
                    id="sysBP"
                    type="number"
                    min="0"
                    placeholder="mmHg"
                    value={formData.sysBP || ""}
                    onChange={(e) => handleInputChange("sysBP", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                    aria-invalid={!!errors.sbp}
                    aria-describedby={errors.sbp ? "sbp-error" : "sbp-help"}
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.sbp ? (
                  <FormError id="sbp-error" message={errors.sbp} />
                ) : (
                  <p id="sbp-help" className="text-xs text-muted-foreground">
                    Top number (90-200 mmHg typical)
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="diaBP" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Diastolic BP
                </Label>
                <div className="flex-1">
                  <Input
                    id="diaBP"
                    type="number"
                    min="0"
                    placeholder="mmHg"
                    value={formData.diaBP || ""}
                    onChange={(e) => handleInputChange("diaBP", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  Bottom number (60-130 mmHg typical)
                </p>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="BMI" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  BMI
                </Label>
                <div className="flex-1">
                  <Input
                    id="BMI"
                    type="number"
                    min="0"
                    step="0.1"
                    placeholder="kg/m²"
                    value={formData.BMI || ""}
                    onChange={(e) => handleInputChange("BMI", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  Body Mass Index (15-50 typical)
                </p>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="heartRate" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Heart Rate
                </Label>
                <div className="flex-1">
                  <Input
                    id="heartRate"
                    type="number"
                    min="0"
                    placeholder="bpm"
                    value={formData.heartRate || ""}
                    onChange={(e) => handleInputChange("heartRate", e.target.value)}
                    className="shadow-sm focus:shadow-md transition-shadow"
                  />
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  Resting heart rate (40-120 bpm)
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Medical History */}
        <div className="space-y-4">
          <div className="flex items-center gap-2 pb-2 border-b">
            <div className="w-1 h-5 bg-gradient-to-b from-pink-500 to-pink-400 rounded-full" />
            <h3 className="text-sm font-semibold text-foreground uppercase tracking-wide">
              Medical History
            </h3>
          </div>
          
          <div className="grid sm:grid-cols-2 gap-4">
            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="BPMeds" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  BP Medications
                </Label>
                <div className="flex-1">
                  <select
                    id="BPMeds"
                    value={formData.BPMeds}
                    onChange={(e) => handleInputChange("BPMeds", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    aria-invalid={!!errors.treated}
                    aria-describedby={errors.treated ? "treated-error" : "treated-help"}
                  >
                    <option value={0}>No</option>
                    <option value={1}>Yes</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.treated ? (
                  <FormError id="treated-error" message={errors.treated} />
                ) : (
                  <p id="treated-help" className="text-xs text-muted-foreground">
                    Currently on antihypertensive drugs
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="diabetes" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Diabetes
                </Label>
                <div className="flex-1">
                  <select
                    id="diabetes"
                    value={formData.diabetes}
                    onChange={(e) => handleInputChange("diabetes", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    aria-invalid={!!errors.diabetes}
                    aria-describedby={errors.diabetes ? "diabetes-error" : "diabetes-help"}
                  >
                    <option value={0}>No</option>
                    <option value={1}>Yes</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                {errors.diabetes ? (
                  <FormError id="diabetes-error" message={errors.diabetes} />
                ) : (
                  <p id="diabetes-help" className="text-xs text-muted-foreground">
                    Diagnosed with diabetes
                  </p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="prevalentHyp" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Hypertension
                </Label>
                <div className="flex-1">
                  <select
                    id="prevalentHyp"
                    value={formData.prevalentHyp}
                    onChange={(e) => handleInputChange("prevalentHyp", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                  >
                    <option value={0}>No</option>
                    <option value={1}>Yes</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  History of high blood pressure
                </p>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-baseline gap-2 sm:gap-4">
                <Label 
                  htmlFor="prevalentStroke" 
                  className="text-sm font-medium sm:w-48 text-foreground flex-shrink-0"
                >
                  Previous Stroke
                </Label>
                <div className="flex-1">
                  <select
                    id="prevalentStroke"
                    value={formData.prevalentStroke}
                    onChange={(e) => handleInputChange("prevalentStroke", e.target.value)}
                    className="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:shadow-md transition-shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                  >
                    <option value={0}>No</option>
                    <option value={1}>Yes</option>
                  </select>
                </div>
              </div>
              <div className="sm:pl-[calc(12rem+1rem)]">
                <p className="text-xs text-muted-foreground">
                  History of stroke or TIA
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="pt-2 pb-1 border-t">
          <p className="text-xs text-muted-foreground text-center">
            This is an educational risk assessment based on the Framingham Heart Study CVD model. Not a medical diagnosis.
          </p>
        </div>

        {result && (
          <RiskPanel
            label="Cardiovascular Risk Assessment"
            probability={result.probability}
            drivers={[
              "Cholesterol levels indicate elevated risk",
              "Blood pressure readings above optimal range",
              "Smoking status contributes to increased risk",
            ]}
            onBookAppointment={async () => {
              try {
                const response = await fetch("/api/appointments", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId: diagnostic?.user_id,
                    diagnosticId: test.diagnostic_id,
                  }),
                });

                if (response.ok) {
                  alert(
                    "✅ Appointment scheduled successfully! Check the appointments section below or visit /appointments to manage it."
                  );
                  onAppointmentBooked?.();
                } else {
                  alert(
                    "❌ Failed to submit appointment request. Please try again."
                  );
                }
              } catch (error) {
                console.error("Error booking appointment:", error);
                alert(
                  "❌ Error submitting appointment request. Please try again."
                );
              }
            }}
            onDownloadFHIR={() => {
              // TODO: Implement FHIR export
              alert("FHIR export coming soon!");
            }}
            className="mt-6"
          />
        )}

        <div className="flex gap-3 pt-4">
          <Button variant="outline" onClick={onClose} className="flex-1">
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="flex-1 bg-gradient-to-r from-brand-500 to-cyan-500 hover:from-brand-600 hover:to-cyan-600 text-white shadow-lg hover:shadow-xl transition-all relative group"
          >
            {showSuccess ? (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                className="flex items-center gap-2"
              >
                <Check className="w-4 h-4" />
                Saved
              </motion.div>
            ) : isSubmitting ? (
              "Processing..."
            ) : (
              <>
                Run ML Prediction
                <kbd className="ml-2 hidden sm:inline-flex h-5 px-1.5 items-center gap-1 rounded border bg-white/20 text-[10px] font-medium text-white">
                  {typeof navigator !== "undefined" && navigator.platform.includes("Mac") ? "⌘" : "Ctrl"} Enter
                </kbd>
              </>
            )}
          </Button>
        </div>
      </div>
    </DialogContent>
  );
}

function TestResultModal({
  test,
  diagnostic,
  onClose,
  onAppointmentBooked,
}: {
  test: TestRecord;
  diagnostic: DiagnosticRecord;
  onClose: () => void;
  onAppointmentBooked?: () => void;
}) {
  if (test.test_id === "fasting_glucose_blood_test") {
    return (
      <DiabetesTestModal
        test={test}
        diagnostic={diagnostic}
        onClose={onClose}
        onAppointmentBooked={onAppointmentBooked}
      />
    );
  }

  if (test.test_id === "cardiovascular_risk_panel") {
    return (
      <CardiovascularTestModal
        test={test}
        diagnostic={diagnostic}
        onClose={onClose}
        onAppointmentBooked={onAppointmentBooked}
      />
    );
  }

  // Default modal for other tests
  return (
    <DialogContent className="sm:max-w-md">
      <DialogHeader>
        <DialogTitle>Test Results - {test.test_name}</DialogTitle>
      </DialogHeader>

      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="test-results">Test Results</Label>
          <Input
            id="test-results"
            placeholder="Enter test results..."
            className="min-h-[100px]"
          />
        </div>

        <div className="flex gap-2 pt-4">
          <Button variant="outline" onClick={onClose} className="flex-1">
            Cancel
          </Button>
          <Button className="flex-1 bg-gradient-to-r from-purple-400 to-pink-400 hover:from-purple-500 hover:to-pink-500">
            Save Results
          </Button>
        </div>
      </div>
    </DialogContent>
  );
}

export default function DiagnosticDetailsPage() {
  const params = useParams();
  const id = params?.id as string;
  const [diagnostic, setDiagnostic] = useState<DiagnosticRecord | null>(null);
  const [tests, setTests] = useState<TestRecord[]>([]);
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [appointmentsLoading, setAppointmentsLoading] = useState(false);
  const [loading, setLoading] = useState(true);
  const [selectedTest, setSelectedTest] = useState<TestRecord | null>(null);

  const refreshAppointments = async () => {
    if (!id) return;
    setAppointmentsLoading(true);
    try {
      const { data: appointmentsData, error: appointmentsError } =
        await supabase
          .from("appointments")
          .select("*")
          .eq("diagnostic_id", id)
          .order("created_at", { ascending: false });

      if (!appointmentsError) {
        setAppointments(appointmentsData || []);
      }
    } catch (error) {
      console.error("Error refreshing appointments:", error);
    } finally {
      setAppointmentsLoading(false);
    }
  };

  useEffect(() => {
    if (!id) return;

    const fetchData = async () => {
      try {
        // Fetch diagnostic
        const { data: diagnosticData, error: diagnosticError } = await supabase
          .from("diagnostics")
          .select("*")
          .eq("id", id)
          .single();

        if (diagnosticError) {
          console.error("Error fetching diagnostic:", diagnosticError);
          return;
        }

        // Fetch tests
        const { data: testsData, error: testsError } = await supabase
          .from("tests")
          .select("id, diagnostic_id, test_name, status, result_file, test_id")
          .eq("diagnostic_id", id);

        if (testsError) {
          console.error("Error fetching tests:", testsError);
        }

        // Fetch appointments for this diagnostic
        const { data: appointmentsData, error: appointmentsError } =
          await supabase
            .from("appointments")
            .select("*")
            .eq("diagnostic_id", id)
            .order("created_at", { ascending: false });

        if (appointmentsError) {
          console.error("Error fetching appointments:", appointmentsError);
        }

        setDiagnostic(diagnosticData);
        setTests(testsData || []);
        setAppointments(appointmentsData || []);
      } catch (error) {
        console.error("Error:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [id]);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading diagnostic details...</p>
        </div>
      </div>
    );
  }

  if (!diagnostic) {
    notFound();
  }

  const scheduledDate = new Date(diagnostic.scheduled_date);
  const formattedDate = scheduledDate.toLocaleDateString("en-US", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });
  const formattedTime = scheduledDate.toLocaleTimeString("en-US", {
    hour: "2-digit",
    minute: "2-digit",
  });

  return (
    <PageContainer maxWidth="full" className="p-4">
      {/* Header */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-4">
        <div className="bg-gradient-to-r from-purple-400 to-pink-400 text-white p-6">
          <h1 className="text-3xl font-bold">Diagnostic Assessment</h1>
          <p className="text-purple-100 mt-2">Assessment ID: {id}</p>
          <div className="flex items-center mt-4">
            <span
              className={`inline-flex px-3 py-1 rounded-full text-sm font-medium ${
                diagnostic.status === "scheduled"
                  ? "bg-blue-100 bg-opacity-20 text-blue-100 border border-blue-200"
                  : "bg-gray-100 bg-opacity-20 text-gray-100 border border-gray-200"
              }`}
            >
              Status:{" "}
              {diagnostic.status.charAt(0).toUpperCase() +
                diagnostic.status.slice(1)}
            </span>
          </div>
        </div>
      </div>

        <div className="grid lg:grid-cols-3 gap-6">
          {/* Main Content */}
          <div className="lg:col-span-2 space-y-6">
            {/* Symptom */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                🩺 Reported Symptoms
              </h2>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="text-gray-800 font-medium">
                  {diagnostic.symptom}
                </p>
              </div>
            </div>

            {/* AI Summary */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                🤖 AI Assessment
              </h2>
              <div className="bg-gray-50 rounded-lg p-4">
                <div
                  className="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap"
                  dangerouslySetInnerHTML={{
                    __html: diagnostic.ai_summary.replace(/\n/g, "<br />"),
                  }}
                />
              </div>
            </div>

            {/* Tests for this Diagnostic */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                🔬 Your Tests
              </h2>

              {tests.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <div className="text-4xl mb-4">🧪</div>
                  <p className="text-lg font-medium mb-2">No tests found</p>
                  <p className="text-sm">
                    No tests have been assigned to this diagnostic yet.
                  </p>
                </div>
              ) : (
                <div className="grid md:grid-cols-2 gap-4">
                  {tests.map((test) => (
                    <div
                      key={test.id}
                      className="border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors"
                    >
                      <div className="flex justify-between items-start mb-3">
                        <h3 className="font-medium text-gray-900 text-sm leading-tight">
                          {test.test_name}
                        </h3>
                        <span
                          className={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                            test.status === "pending"
                              ? "bg-yellow-100 text-yellow-800"
                              : test.status === "completed"
                                ? "bg-green-100 text-green-800"
                                : test.status === "in_progress"
                                  ? "bg-blue-100 text-blue-800"
                                  : "bg-gray-100 text-gray-800"
                          }`}
                        >
                          {test.status.charAt(0).toUpperCase() +
                            test.status.slice(1).replace("_", " ")}
                        </span>
                      </div>

                      <div className="space-y-2 mb-4">
                        <div className="flex justify-between text-sm">
                          <span className="text-gray-600">Test ID:</span>
                          <span className="font-mono text-gray-900 text-xs bg-gray-100 px-2 py-1 rounded">
                            {test.test_id}
                          </span>
                        </div>
                        {test.result_file && (
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Results:</span>
                            <a
                              href={test.result_file}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-purple-600 hover:text-purple-800 font-medium"
                            >
                              View File
                            </a>
                          </div>
                        )}
                      </div>

                      <div className="flex gap-2">
                        {test.status === "completed" && test.result_file && (
                          <button className="flex-1 bg-gradient-to-r from-green-400 to-green-500 text-white py-2 px-3 rounded-lg text-sm font-medium hover:from-green-500 hover:to-green-600 transition-colors">
                            View Results
                          </button>
                        )}
                        {test.status === "pending" && (
                          <Button
                            size="sm"
                            className="flex-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white hover:from-purple-500 hover:to-pink-500"
                            onClick={() => setSelectedTest(test)}
                          >
                            Enter Results
                          </Button>
                        )}
                        {test.status === "in_progress" && (
                          <button className="flex-1 bg-gradient-to-r from-blue-400 to-blue-500 text-white py-2 px-3 rounded-lg text-sm font-medium hover:from-blue-500 hover:to-blue-600 transition-colors">
                            Check Status
                          </button>
                        )}
                        <button className="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                          Details
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Appointment Details */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">
                📅 Appointment Details
              </h2>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Hospital
                  </label>
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p className="text-gray-800 font-medium">
                      {diagnostic.hospital}
                    </p>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Scheduled Date
                  </label>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p className="font-medium text-gray-900">{formattedDate}</p>
                    <p className="text-gray-700 text-sm">{formattedTime}</p>
                  </div>
                </div>

                {diagnostic.test_name && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Recommended Test
                    </label>
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                      <p className="text-gray-800 font-medium">
                        {diagnostic.test_name}
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Test Summary */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">
                📊 Test Summary
              </h2>

              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">Total Tests:</span>
                  <span className="font-semibold text-gray-900">
                    {tests.length}
                  </span>
                </div>

                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">Pending:</span>
                  <span className="font-semibold text-yellow-600">
                    {tests.filter((test) => test.status === "pending").length}
                  </span>
                </div>

                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">In Progress:</span>
                  <span className="font-semibold text-blue-600">
                    {
                      tests.filter((test) => test.status === "in_progress")
                        .length
                    }
                  </span>
                </div>

                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-600">Completed:</span>
                  <span className="font-semibold text-green-600">
                    {tests.filter((test) => test.status === "completed").length}
                  </span>
                </div>
              </div>
            </div>

            {/* Appointments Section */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-gray-900">
                  📅 Appointments{" "}
                  {appointmentsLoading && (
                    <span className="ml-2 text-sm text-gray-500">
                      (updating...)
                    </span>
                  )}
                </h2>
                {appointments.length > 0 && (
                  <Button
                    onClick={() => (window.location.href = "/appointments")}
                    variant="outline"
                    size="sm"
                    className="text-purple-600 border-purple-300 hover:bg-purple-50"
                  >
                    View All
                  </Button>
                )}
              </div>

              {appointments.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-4xl mb-3">🩺</div>
                  <h3 className="text-lg font-semibold text-gray-900 mb-2">
                    No Appointments Yet
                  </h3>
                  <p className="text-gray-600 text-sm mb-4 max-w-sm mx-auto">
                    Complete your diabetes screening test below. If high risk is
                    detected, you&apos;ll be able to schedule an appointment
                    with a doctor automatically.
                  </p>
                  <Button
                    onClick={() => (window.location.href = "/appointments")}
                    variant="outline"
                    size="sm"
                    className="text-purple-600 border-purple-300 hover:bg-purple-50"
                  >
                    View Appointments Page
                  </Button>
                </div>
              ) : (
                <div className="space-y-3">
                  {appointments.slice(0, 2).map((appointment) => {
                    const appointmentDate = new Date(
                      appointment.appointment_date
                    );
                    const isUpcoming = appointmentDate > new Date();

                    return (
                      <div
                        key={appointment.id}
                        className="border border-gray-200 rounded-lg p-3 hover:border-purple-300 hover:bg-purple-50 transition-colors cursor-pointer"
                        onClick={() => (window.location.href = "/appointments")}
                      >
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-sm font-medium text-gray-900">
                                Dr. Sarah Johnson
                              </span>
                              <span
                                className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                  appointment.status === "scheduled"
                                    ? "bg-yellow-100 text-yellow-800"
                                    : appointment.status === "confirmed"
                                      ? "bg-green-100 text-green-800"
                                      : appointment.status === "completed"
                                        ? "bg-blue-100 text-blue-800"
                                        : "bg-red-100 text-red-800"
                                }`}
                              >
                                {appointment.status.charAt(0).toUpperCase() +
                                  appointment.status.slice(1)}
                              </span>
                            </div>

                            <div className="text-sm text-gray-600">
                              <div className="flex items-center gap-1">
                                <span>📅</span>
                                <span>
                                  {appointmentDate.toLocaleDateString("en-US", {
                                    month: "short",
                                    day: "numeric",
                                    year: "numeric",
                                  })}
                                </span>
                                <span>•</span>
                                <span>{appointment.appointment_time}</span>
                              </div>
                            </div>
                          </div>

                          {isUpcoming && (
                            <div className="text-xs text-purple-600 font-medium">
                              {Math.ceil(
                                (appointmentDate.getTime() -
                                  new Date().getTime()) /
                                  (1000 * 60 * 60 * 24)
                              )}{" "}
                              days
                            </div>
                          )}
                        </div>

                        <div className="text-xs text-gray-500">
                          Click to manage appointment
                        </div>
                      </div>
                    );
                  })}

                  {appointments.length > 2 && (
                    <div className="text-center pt-2">
                      <Button
                        onClick={() => (window.location.href = "/appointments")}
                        variant="ghost"
                        size="sm"
                        className="text-purple-600 hover:text-purple-700"
                      >
                        +{appointments.length - 2} more appointment
                        {appointments.length - 2 > 1 ? "s" : ""}
                      </Button>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Quick Actions */}
            {/* <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">
                ⚡ Quick Actions
              </h2>

              <div className="space-y-3">
                <button className="w-full bg-gradient-to-r from-blue-400 to-blue-500 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-500 hover:to-blue-600 transition-colors text-left">
                  <div className="flex items-center">
                    <span className="text-lg mr-3">📞</span>
                    <div>
                      <div className="font-medium">Call Hospital</div>
                      <div className="text-blue-100 text-sm">
                        Schedule or modify appointment
                      </div>
                    </div>
                  </div>
                </button>

                <button className="w-full bg-gradient-to-r from-green-400 to-green-500 text-white py-3 px-4 rounded-lg font-medium hover:from-green-500 hover:to-green-600 transition-colors text-left">
                  <div className="flex items-center">
                    <span className="text-lg mr-3">📋</span>
                    <div>
                      <div className="font-medium">Download Summary</div>
                      <div className="text-green-100 text-sm">
                        Get PDF report
                      </div>
                    </div>
                  </div>
                </button>

                <button className="w-full bg-gradient-to-r from-purple-400 to-pink-400 text-white py-3 px-4 rounded-lg font-medium hover:from-purple-500 hover:to-pink-500 transition-colors text-left">
                  <div className="flex items-center">
                    <span className="text-lg mr-3">💬</span>
                    <div>
                      <div className="font-medium">Chat with AI</div>
                      <div className="text-purple-100 text-sm">
                        Ask follow-up questions
                      </div>
                    </div>
                  </div>
                </button>

                <button className="w-full bg-gradient-to-r from-gray-400 to-gray-500 text-white py-3 px-4 rounded-lg font-medium hover:from-gray-500 hover:to-gray-600 transition-colors text-left">
                  <div className="flex items-center">
                    <span className="text-lg mr-3">🗓️</span>
                    <div>
                      <div className="font-medium">Reschedule</div>
                      <div className="text-gray-100 text-sm">
                        Change appointment time
                      </div>
                    </div>
                  </div>
                </button>
              </div>
            </div> */}

            {/* Emergency Contact */}
            {/* <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <h3 className="font-semibold text-red-800 mb-2">
                🚨 Emergency Contact
              </h3>
              <p className="text-red-700 text-sm mb-2">
                If you experience severe symptoms, don't wait for your
                appointment.
              </p>
              <button className="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                Call Emergency: 911
              </button>
            </div> */}
          </div>
        </div>

      {/* Test Result Modal */}
      {selectedTest && (
        <Dialog
          open={!!selectedTest}
          onOpenChange={(open) => !open && setSelectedTest(null)}
        >
          <TestResultModal
            test={selectedTest}
            diagnostic={diagnostic}
            onClose={() => setSelectedTest(null)}
            onAppointmentBooked={refreshAppointments}
          />
        </Dialog>
      )}
    </PageContainer>
  );
}
